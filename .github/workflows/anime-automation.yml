name: Automatisation Anime

on:
  schedule:
    - cron: "43 4 * * *"   # pour un post √† 08h00 FR
    - cron: "13 15 * * *"  # pour un post √† 18h30 FR
  workflow_dispatch:


jobs:
  anime-automation:
    runs-on: windows-latest
    timeout-minutes: 120

    env:
      # Cloudinary
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

      # Telegram
      TELEGRAM_TO: ${{ secrets.TELEGRAM_TO }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}

      # Email
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      RESEND_TO: ${{ secrets.RESEND_TO }}

      # Hugging Face
      HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}

      # MetriCool
      METRICOOL_EMAIL: ${{ secrets.METRICOOL_EMAIL }}
      METRICOOL_PASSWORD: ${{ secrets.METRICOOL_PASSWORD }}

    steps:
      - name: üîç Inventaire outils pr√©-install√©s
        run: |
          Write-Host "=== Chocolatey packages ==="
          choco list

          Write-Host "=== Versions languages ==="
          node --version
          python --version
          git --version

          Write-Host "=== Outils syst√®me ==="
          Get-Command 7z -ErrorAction SilentlyContinue
          Get-Command ffmpeg -ErrorAction SilentlyContinue
          Get-Command aria2c -ErrorAction SilentlyContinue

      - name: üì¶ Checkout du code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: üì¶ Installation des d√©pendances (avec legacy-peer-deps)
        run: npm ci --legacy-peer-deps

      # === Installation FFmpeg avec cache ===
      - name: üé¨ Cache FFmpeg
        uses: actions/cache@v4
        id: cache-ffmpeg
        with:
          path: |
            C:\ProgramData\chocolatey\lib\ffmpeg
            C:\ProgramData\chocolatey\bin\ffmpeg.exe
            C:\ProgramData\chocolatey\bin\ffprobe.exe
          key: ffmpeg-${{ runner.os }}-v2
          restore-keys: |
            ffmpeg-${{ runner.os }}-

      - name: üì¶ Installer FFmpeg 7.1.1 (gyan.dev)
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          Write-Host "üîΩ T√©l√©chargement de FFmpeg 7.1.1 essentials..."
          curl -L -o ffmpeg.7z https://www.gyan.dev/ffmpeg/builds/packages/ffmpeg-7.1.1-essentials_build.7z

          Write-Host "üìÇ Extraction..."
          7z x ffmpeg.7z -o"$env:RUNNER_TEMP\ffmpeg" -y

          Write-Host "‚ûï Ajout de FFmpeg au PATH"
          echo "$env:RUNNER_TEMP\ffmpeg\ffmpeg-7.1.1-essentials_build\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          Write-Host "‚úÖ FFmpeg 7.1.1 install√©"

      - name: üß™ V√©rifier installation FFmpeg
        run: |
          Write-Host "=== Test FFmpeg ==="
          ffmpeg -version | Select-String "ffmpeg version" | Select-Object -First 1
          ffprobe -version | Select-String "ffprobe version" | Select-Object -First 1

          Write-Host "=== Chemins FFmpeg ==="
          Get-Command ffmpeg | Select-Object Source
          Get-Command ffprobe | Select-Object Source

          Write-Host "‚úÖ FFmpeg op√©rationnel !"

      # === Installation aria2 avec cache ===
      - name: ‚ö° Cache aria2
        uses: actions/cache@v4
        id: cache-aria2
        with:
          path: |
            C:\ProgramData\chocolatey\lib\aria2
            C:\ProgramData\chocolatey\bin\aria2c.exe
          key: aria2-${{ runner.os }}-v2
          restore-keys: |
            aria2-${{ runner.os }}-

      - name: üì¶ Installer aria2
        if: steps.cache-aria2.outputs.cache-hit != 'true'
        run: |
          Write-Host "üîΩ Installation de aria2..."
          choco install aria2 -y --no-progress
          Write-Host "‚úÖ aria2 install√© avec succ√®s"

      - name: üß™ V√©rifier installation aria2
        run: |
          Write-Host "=== Test aria2 ==="
          aria2c --version | Select-String "aria2 version" | Select-Object -First 1

          Write-Host "=== Chemin aria2 ==="
          Get-Command aria2c | Select-Object Source

          Write-Host "‚úÖ aria2 op√©rationnel !"

      # === V√©rification 7z ===
      - name: üóúÔ∏è V√©rifier installation 7z
        run: |
          Write-Host "=== Test 7z ==="
          7z | Select-String "7-Zip" | Select-Object -First 1

          Write-Host "=== Chemin 7z ==="
          Get-Command 7z | Select-Object Source

          Write-Host "‚úÖ 7z op√©rationnel !"

      - name: üîë G√©n√©rer LOGIN_HASH (Windows)
        env:
          METRICOOL_EMAIL: ${{ secrets.METRICOOL_EMAIL }}
          METRICOOL_PASSWORD: ${{ secrets.METRICOOL_PASSWORD }}
        run: |
          $output = npx tsx scripts/generate-login-hash.ts
          $loginHash = $output.Split('=')[1].Trim()
          echo "LOGIN_HASH=$loginHash" >> $env:GITHUB_ENV
        shell: pwsh


      - name: üíæ Restaurer le cookie Playwright
        uses: actions/cache@v4
        id: cookie-cache
        with:
          path: |
            cookies.json
            cookies.meta.json
          key: playwright-cookie-${{ runner.os }}-${{ env.LOGIN_HASH }}


      - name: üíæ Cache des navigateurs Playwright (Windows)
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: C:\Users\runneradmin\.cache\ms-playwright
          key: playwright-${{ runner.os }}

      - name: üåê Installer les navigateurs Playwright
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npm exec playwright install --with-deps


      # === T√©l√©chargement depuis releases priv√©es avec GitHub API ===
      - name: üîë R√©cup√©rer les URLs des releases priv√©es
        id: get-release-urls
        run: |
          Write-Host "üîë Acc√®s aux releases du repository priv√©..."

          # Headers pour authentification GitHub API
          $headers = @{
            "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
            "Accept" = "application/vnd.github+json"
            "X-GitHub-Api-Version" = "2022-11-28"
            "User-Agent" = "GitHubActions/1.0"
          }

          Write-Host "üìã R√©cup√©ration des releases..."

          # Variables pour stocker les URLs
          $binDownloadUrl = ""
          $modelDownloadUrl001 = ""
          $modelDownloadUrl002 = ""

          # Obtenir la release binaire v1.0-binaire
          try {
            Write-Host "üîç Recherche release v1.0-binaire..."
            $binRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/tags/v1.0-binaire" -Headers $headers -ErrorAction Stop
            Write-Host "‚úÖ Release binaire trouv√©e: $($binRelease.name)"

            # Chercher l'asset binaire
            $binAsset = $binRelease.assets | Where-Object { $_.name -eq "Faster-Whisper-XXL_r245.4_windows.7z" }
            if ($binAsset) {
              Write-Host "‚úÖ Asset binaire trouv√©: $($binAsset.name) (Taille: $([math]::Round($binAsset.size/1MB, 2)) MB)"
              $binDownloadUrl = $binAsset.url
            } else {
              Write-Host "‚ùå Asset binaire 'Faster-Whisper-XXL_r245.4_windows.7z' non trouv√© dans la release"
              Write-Host "Assets disponibles:"
              $binRelease.assets | ForEach-Object { Write-Host "  - $($_.name)" }
            }
          } catch {
            Write-Host "‚ùå Erreur lors de l'acc√®s √† la release v1.0-binaire:"
            Write-Host "   $($_.Exception.Message)"
            if ($_.Exception.Response.StatusCode -eq 404) {
              Write-Host "   ‚Üí La release 'v1.0-binaire' n'existe pas"
            }
          }

          # Obtenir la release mod√®le v1.0-model
          try {
            Write-Host "üîç Recherche release v1.0-model..."
            $modelRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/tags/v1.0-model" -Headers $headers -ErrorAction Stop
            Write-Host "‚úÖ Release mod√®le trouv√©e: $($modelRelease.name)"

            # Chercher les assets du mod√®le
            $modelAsset1 = $modelRelease.assets | Where-Object { $_.name -eq "Faster-Whisper-XXL_r245.4_windows.7z.001" }
            $modelAsset2 = $modelRelease.assets | Where-Object { $_.name -eq "Faster-Whisper-XXL_r245.4_windows.7z.002" }

            if ($modelAsset1) {
              Write-Host "‚úÖ Asset mod√®le partie 1 trouv√©: $($modelAsset1.name) (Taille: $([math]::Round($modelAsset1.size/1MB, 2)) MB)"
              $modelDownloadUrl001 = $modelAsset1.url
            } else {
              Write-Host "‚ùå Asset mod√®le partie 1 non trouv√©"
            }

            if ($modelAsset2) {
              Write-Host "‚úÖ Asset mod√®le partie 2 trouv√©: $($modelAsset2.name) (Taille: $([math]::Round($modelAsset2.size/1MB, 2)) MB)"
              $modelDownloadUrl002 = $modelAsset2.url
            } else {
              Write-Host "‚ùå Asset mod√®le partie 2 non trouv√©"
            }

            if (!$modelAsset1 -and !$modelAsset2) {
              Write-Host "Assets disponibles dans v1.0-model:"
              $modelRelease.assets | ForEach-Object { Write-Host "  - $($_.name)" }
            }
          } catch {
            Write-Host "‚ùå Erreur lors de l'acc√®s √† la release v1.0-model:"
            Write-Host "   $($_.Exception.Message)"
            if ($_.Exception.Response.StatusCode -eq 404) {
              Write-Host "   ‚Üí La release 'v1.0-model' n'existe pas"
            }
          }

          # Exporter les URLs vers les variables d'environnement pour les √©tapes suivantes
          echo "BIN_DOWNLOAD_URL=$binDownloadUrl" >> $env:GITHUB_ENV
          echo "MODEL_DOWNLOAD_URL_001=$modelDownloadUrl001" >> $env:GITHUB_ENV
          echo "MODEL_DOWNLOAD_URL_002=$modelDownloadUrl002" >> $env:GITHUB_ENV

          Write-Host ""
          Write-Host "üìä R√©sum√© des URLs r√©cup√©r√©es:"
          Write-Host "  Binaire: $(if($binDownloadUrl) { '‚úÖ Disponible' } else { '‚ùå Manquant' })"
          Write-Host "  Mod√®le part 1: $(if($modelDownloadUrl001) { '‚úÖ Disponible' } else { '‚ùå Manquant' })"
          Write-Host "  Mod√®le part 2: $(if($modelDownloadUrl002) { '‚úÖ Disponible' } else { '‚ùå Manquant' })"

      # === Cache et t√©l√©chargement binaire ===
      - name: üíæ Cache Faster-Whisper Binaire
        uses: actions/cache@v4
        id: cache-binaire
        with:
          path: models/Faster-Whisper-XXL_r245.4_windows
          key: fw-binaire-${{ runner.os }}-v3

      - name: ‚¨áÔ∏è T√©l√©charger & extraire Binaire (GitHub API)
        if: steps.cache-binaire.outputs.cache-hit != 'true'
        run: |
          Write-Host "üìÅ Cr√©ation du dossier models..."
          New-Item -ItemType Directory -Path models -Force

          if ($env:BIN_DOWNLOAD_URL -and $env:BIN_DOWNLOAD_URL -ne "") {
            Write-Host "‚¨áÔ∏è T√©l√©chargement du binaire via GitHub API..."

            $headers = @{
              "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
              "Accept" = "application/octet-stream"
              "User-Agent" = "GitHubActions/1.0"
            }

            try {
              Write-Host "üîó URL de t√©l√©chargement: $env:BIN_DOWNLOAD_URL"

              # T√©l√©chargement avec barre de progression
              $ProgressPreference = 'Continue'
              Invoke-WebRequest -Uri $env:BIN_DOWNLOAD_URL -Headers $headers -OutFile "models\Faster-Whisper-XXL_r245.4_windows.7z" -Verbose

              if (Test-Path "models\Faster-Whisper-XXL_r245.4_windows.7z") {
                $fileSize = (Get-Item "models\Faster-Whisper-XXL_r245.4_windows.7z").Length
                Write-Host "‚úÖ T√©l√©chargement binaire r√©ussi (Taille: $([math]::Round($fileSize/1MB, 2)) MB)"

                Write-Host "üì¶ Extraction du binaire..."
                7z x models\Faster-Whisper-XXL_r245.4_windows.7z -omodels -y

                if ($LASTEXITCODE -eq 0) {
                  Write-Host "‚úÖ Binaire extrait avec succ√®s"

                  # V√©rifier le contenu extrait
                  if (Test-Path "models\Faster-Whisper-XXL_r245.4_windows") {
                    Write-Host "üìÇ Contenu extrait:"
                    Get-ChildItem "models\Faster-Whisper-XXL_r245.4_windows" -Recurse | Select-Object Name, Length | Format-Table -AutoSize
                  }
                } else {
                  Write-Host "‚ùå √âchec de l'extraction (code: $LASTEXITCODE)"
                  exit 1
                }
              } else {
                Write-Host "‚ùå Fichier binaire non cr√©√© apr√®s t√©l√©chargement"
                exit 1
              }
            } catch {
              Write-Host "‚ùå Erreur lors du t√©l√©chargement binaire:"
              Write-Host "   $($_.Exception.Message)"
              if ($_.Exception.Response) {
                Write-Host "   Status: $($_.Exception.Response.StatusCode)"
                Write-Host "   Reason: $($_.Exception.Response.ReasonPhrase)"
              }
              exit 1
            }
          } else {
            Write-Host "‚ö†Ô∏è URL de t√©l√©chargement binaire non disponible"
            Write-Host "   V√©rifiez que la release 'v1.0-binaire' existe et contient le fichier 'Faster-Whisper-XXL_r245.4_windows.7z'"
            Write-Host "   Continuons sans ce fichier..."
          }

      # === Cache et t√©l√©chargement mod√®le ===
      - name: üíæ Cache Faster-Whisper Mod√®le
        uses: actions/cache@v4
        id: cache-modele
        with:
          path: models/Faster-Whisper-XXL_r245.4_windows
          key: fw-modele-${{ runner.os }}-v3

      - name: ‚¨áÔ∏è T√©l√©charger & extraire Mod√®le (2 parties via GitHub API)
        if: steps.cache-modele.outputs.cache-hit != 'true'
        run: |
          $headers = @{
            "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
            "Accept" = "application/octet-stream"
            "User-Agent" = "GitHubActions/1.0"
          }

          $download1Success = $false
          $download2Success = $false

          # T√©l√©chargement partie 1
          if ($env:MODEL_DOWNLOAD_URL_001 -and $env:MODEL_DOWNLOAD_URL_001 -ne "") {
            Write-Host "‚¨áÔ∏è T√©l√©chargement mod√®le partie 1 via GitHub API..."
            try {
              $ProgressPreference = 'Continue'
              Invoke-WebRequest -Uri $env:MODEL_DOWNLOAD_URL_001 -Headers $headers -OutFile "models\Faster-Whisper-XXL_r245.4_windows.7z.001" -Verbose

              if (Test-Path "models\Faster-Whisper-XXL_r245.4_windows.7z.001") {
                $fileSize = (Get-Item "models\Faster-Whisper-XXL_r245.4_windows.7z.001").Length
                Write-Host "‚úÖ Partie 1 t√©l√©charg√©e (Taille: $([math]::Round($fileSize/1MB, 2)) MB)"
                $download1Success = $true
              }
            } catch {
              Write-Host "‚ùå Erreur t√©l√©chargement partie 1: $($_.Exception.Message)"
            }
          } else {
            Write-Host "‚ö†Ô∏è URL partie 1 non disponible"
          }

          # T√©l√©chargement partie 2
          if ($env:MODEL_DOWNLOAD_URL_002 -and $env:MODEL_DOWNLOAD_URL_002 -ne "") {
            Write-Host "‚¨áÔ∏è T√©l√©chargement mod√®le partie 2 via GitHub API..."
            try {
              $ProgressPreference = 'Continue'
              Invoke-WebRequest -Uri $env:MODEL_DOWNLOAD_URL_002 -Headers $headers -OutFile "models\Faster-Whisper-XXL_r245.4_windows.7z.002" -Verbose

              if (Test-Path "models\Faster-Whisper-XXL_r245.4_windows.7z.002") {
                $fileSize = (Get-Item "models\Faster-Whisper-XXL_r245.4_windows.7z.002").Length
                Write-Host "‚úÖ Partie 2 t√©l√©charg√©e (Taille: $([math]::Round($fileSize/1MB, 2)) MB)"
                $download2Success = $true
              }
            } catch {
              Write-Host "‚ùå Erreur t√©l√©chargement partie 2: $($_.Exception.Message)"
            }
          } else {
            Write-Host "‚ö†Ô∏è URL partie 2 non disponible"
          }

          # Extraction si les deux parties sont t√©l√©charg√©es
          if ($download1Success -and $download2Success) {
            Write-Host "üì¶ Extraction du mod√®le multi-parties..."
            try {
              7z x models\Faster-Whisper-XXL_r245.4_windows.7z.001 -omodels -y
              if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Mod√®le extrait avec succ√®s"

                # V√©rifier le contenu extrait
                if (Test-Path "models\Faster-Whisper-XXL_r245.4_windows") {
                  Write-Host "üìÇ Contenu extrait:"
                  Get-ChildItem "models\Faster-Whisper-XXL_r245.4_windows" -Recurse | Select-Object Name, Length | Format-Table -AutoSize
                }
              } else {
                Write-Host "‚ùå √âchec de l'extraction (code: $LASTEXITCODE)"
                exit 1
              }
            } catch {
              Write-Host "‚ùå Erreur lors de l'extraction: $($_.Exception.Message)"
              exit 1
            }
          } else {
            Write-Host "‚ö†Ô∏è T√©l√©chargement du mod√®le incomplet"
            Write-Host "   Part 1: $(if($download1Success) { '‚úÖ' } else { '‚ùå' })"
            Write-Host "   Part 2: $(if($download2Success) { '‚úÖ' } else { '‚ùå' })"
            Write-Host "   V√©rifiez que la release 'v1.0-model' existe et contient les fichiers .001 et .002"
            Write-Host "   Continuons sans ce fichier..."
          }

      # === Pipeline vid√©o ===
      - name: üéµ √âtape 1 - T√©l√©chargement voix al√©atoire
        run: npm run start

      - name: üé¨ √âtape 2 - S√©lection des clips anime
        run: npm run select-clips

      - name: üîó √âtape 3 - Concat√©nation clips avec transitions
        run: npm run concat-clips

      - name: ‚ú® √âtape 4 - Application effets TikTok
        run: npm run ffmpeg-tiktok-effects

      - name: üéµ √âtape 5 - T√©l√©chargement OST al√©atoire
        run: npm run download-random-ost

      - name: üìù √âtape 6 - G√©n√©ration des sous-titres
        run: npm run generate-subs

      - name: üßπ √âtape 7 - Nettoyage des sous-titres
        run: npm run clean-subs

      - name: ‚úçÔ∏è √âtape 8 - G√©n√©ration drawtext
        run: npm run generate-drawtext

      - name: üìñ √âtape 9 - Ajout des sous-titres
        run: npm run add-subtitles

      - name: üîä √âtape 10 - Mixage audio
        run: npm run mix-audio

      - name: ü§ñ √âtape 11 - Analyse contexte pour emojis
        run: npm run contextual-emoji

      - name: ‚¨áÔ∏è √âtape 12 - T√©l√©charger emojis anim√©s
        run: npm run download-animated-emojis

      - name: üòÉ √âtape 13 - Appliquer emojis anim√©s sur la vid√©o
        run: npm run apply-emoji-ffmpeg

      # === Upload & publication ===
      - name: ‚òÅÔ∏è Upload Cloudinary
        run: npm run upload-to-cloudinary

      - name: üì± Publication TikTok
        run: npm run put-to-tiktok
        env:
          CHROMIUM_FLAGS: "--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage --disable-gpu --disable-web-security --disable-features=VizDisplayCompositor"

      # === Artifacts ===
      - name: üíæ Sauvegarde vid√©o finale
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: anime-video-${{ github.run_number }}
          path: |
            output.mp4
            output_video.mp4
            output_pre_final.mp4
            output_final.mp4
            output_with_emojis.mp4
          retention-days: 7

      - name: üíæ Sauvegarde JSON
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: json-public-subs
          path: |
            public/*.json
            subs/*.json
          retention-days: 7

      - name: üíæ Sauvegarde logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: logs-${{ github.run_number }}
          path: |
            *.log
            logs/
            cloudinary-link.txt
          retention-days: 3

      - name: üì¢ Notifier Telegram (Succ√®s ou √âchec)
        if: always()
        run: |
          $status = "${{ job.status }}"
          $msg = if ($status -eq "success") { "‚úÖ Automatisation Anim√© termin√©e avec succ√®s !" } else { "‚ùå √âchec Automatisation Anim√© !" }
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" `
            -d chat_id=${{ secrets.TELEGRAM_TO }} `
            -d text="$msg`nWorkflow: ${{ github.workflow }}`nJob: ${{ github.job }}`nCommit: ${{ github.sha }}`nAuteur: ${{ github.actor }}`nLien: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: üìß Envoyer mail stylis√© React Email + Tailwind via Resend
        if: always()
        run: npm run send-email
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_TO: ${{ secrets.RESEND_TO }}
          STATUS: ${{ job.status }}
          STATUS_EMOJI: ${{ job.status == 'success' && 'üéâ' || 'üí•' }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_RUN_ID: ${{ github.run_id }}

      # === Nettoyage ===
      - name: üßπ Nettoyage fichiers temporaires
        if: always()
        run: |
          if (Test-Path temp) { Remove-Item -Recurse -Force temp }
          if (Test-Path cache) { Remove-Item -Recurse -Force cache }
          Get-ChildItem -Recurse -Include *.tmp, *.temp -ErrorAction SilentlyContinue | Remove-Item -Force

      - name: üíæ Sauvegarder le cookie Playwright (Windows)
        uses: actions/cache@v4
        with:
          path: |
            cookies.json
            cookies.meta.json
          key: playwright-cookie-${{ runner.os }}-${{ env.LOGIN_HASH }}

      - name: üíæ Sauvegarder le cache des navigateurs Playwright (Windows)
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\.cache\ms-playwright
          key: playwright-${{ runner.os }}

