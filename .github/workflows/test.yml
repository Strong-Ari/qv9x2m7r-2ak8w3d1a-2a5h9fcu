name: Test FFmpeg Impact

on:
  workflow_dispatch:

jobs:
  ffmpeg-impact-test:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # === Installation FFmpeg avec cache ===
      - name: ðŸŽ¬ Cache FFmpeg
        uses: actions/cache@v4
        id: cache-ffmpeg
        with:
          path: |
            C:\ProgramData\chocolatey\lib\ffmpeg
            C:\ProgramData\chocolatey\bin\ffmpeg.exe
            C:\ProgramData\chocolatey\bin\ffprobe.exe
          key: ffmpeg-${{ runner.os }}-v2
          restore-keys: |
            ffmpeg-${{ runner.os }}-

      - name: ðŸ“¦ Installer FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          Write-Host "ðŸ”½ Installation de FFmpeg..."
          choco install ffmpeg -y --no-progress
          Write-Host "âœ… FFmpeg installÃ© avec succÃ¨s"

      - name: ðŸ§ª VÃ©rifier installation FFmpeg
        run: |
          Write-Host "=== Test FFmpeg ==="
          ffmpeg -version | Select-String "ffmpeg version" | Select-Object -First 1
          ffprobe -version | Select-String "ffprobe version" | Select-Object -First 1

          Write-Host "=== Chemins FFmpeg ==="
          Get-Command ffmpeg | Select-Object Source
          Get-Command ffprobe | Select-Object Source

          Write-Host "âœ… FFmpeg opÃ©rationnel !"

      - name: Prepare test image
        run: |
          mkdir test
          # CrÃ©e une image blanche unique 800x600
          ffmpeg -f lavfi -i color=c=white:s=800x600 -frames:v 1 test/input.png

      - name: Locate Impact font
        run: |
          Write-Host "Recherche Impact..."
          Get-ChildItem "C:\Windows\Fonts" -Filter "*Impact*" | Select-Object -ExpandProperty FullName

      - name: Check Impact font
        run: |
          dir "C:\Windows\Fonts\impact.ttf"

      - name: Apply drawtext with Impact
        run: |
          ffmpeg -i test/input.png -frames:v 1 -vf "drawtext=fontfile='C\:/Windows/Fonts/impact.ttf':text='TEST IMPACT':x=(w-text_w)/2:y=(h-text_h)/2:fontsize=48:fontcolor=red:borderw=2:bordercolor=black" test/output.png

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-impact-test-result
          path: test/output.png
